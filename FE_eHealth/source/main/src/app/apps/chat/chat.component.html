<section class="content">
  <div class="content-block">
    <div class="block-header">
      <!-- breadcrumb -->
      <app-breadcrumb [title]="'Chat'" [items]="['Apps']" [active_item]="'Chat'">
      </app-breadcrumb>
    </div>

    <div class="row">
      <!-- Sidebar (3 cột) -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
        <div class="card">
          <div class="body">
            <div id="plist" class="people-list">
              <!-- Ô tìm kiếm -->
              <div class="form-line m-b-15">
                <input type="text" class="form-control" placeholder="Search..." [(ngModel)]="searchTerm" />
              </div>
              <div class="tab-content">
                <ng-scrollbar style="height: 590px" visibility="hover">
                  <div id="chat_user">
                    <ul class="chat-list list-unstyled m-b-0">
                      <!-- Lặp contacts -->
                      <li class="clearfix" *ngFor="let user of contacts"
                        [ngClass]="user.id === selectedContactId ? 'active' : ''" (click)="selectContact(user)">
                        <img [src]="user.avatarUrl || 'assets/images/user/default-avatar.png'" alt="avatar" />
                        <div class="about">
                          <div class="name">{{ user.fullName }}</div>
                          <div class="status">
                            <i class="material-icons" [ngClass]="user.isOnline ? 'online' : 'offline'">
                              fiber_manual_record
                            </i>
                            {{ user.isOnline ? 'online' : 'offline' }}
                          </div>
                        </div>
                      </li>
                      <li *ngIf="contacts.length === 0" class="text-center p-2 text-muted">
                        Không có contact
                      </li>
                    </ul>
                  </div>
                </ng-scrollbar>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat chính (9 cột) -->
      <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">
        <div class="card">
          <div class="chat">
            <!-- Chat header -->
            <div class="chat-header clearfix">
              <ng-container *ngIf="selectedContactId; else noContact">
                <img [src]="getSelectedContactAvatar()" alt="avatar" />
                <div class="chat-about">
                  <div class="chat-with">{{ selectedContactName }}</div>
                  <div class="chat-num-messages">
                    {{ unreadCount || 0 }} new message{{ unreadCount > 1 ? 's' : '' }}
                  </div>
                </div>
              </ng-container>
              <ng-template #noContact>
                <span>Chọn một contact để chat</span>
              </ng-template>
            </div>

            <!-- Phần lịch sử tin nhắn -->
            <ng-scrollbar style="height: 450px" visibility="hover">
              <div class="chat-history" id="chat-conversation">
                <ul>
                  <!-- Lặp qua từng tin nhắn -->
                  <li class="clearfix" *ngFor="let m of messages">
                    <!-- Tin của đối phương (nằm trái) -->
                    <ng-container *ngIf="m.senderId !== currentUserId">
                      <div class="message-sender-name left">
                        {{ getContactName(m.senderId) }}
                      </div>
                      <div class="message-box other-message">
                        <div class="message-text">
                          <p>{{ m.content }}</p>
                        </div>
                        <div class="message-time">
                          {{ m.sentAt | date:'HH:mm, dd/MM' }}
                        </div>
                      </div>
                    </ng-container>

                    <!-- Tin của tôi (nằm phải) -->
                    <ng-container *ngIf="m.senderId === currentUserId">
                      <div class="message-sender-name right">
                        Tôi
                      </div>
                      <div class="message-box my-message">
                        <div class="message-text">
                          <p>{{ m.content }}</p>
                        </div>
                        <div class="message-time">
                          {{ m.sentAt | date:'HH:mm, dd/MM' }}
                        </div>
                      </div>
                    </ng-container>
                  </li>

                  <!-- Nếu messages rỗng -->
                  <li *ngIf="messages.length === 0" class="text-center p-4 text-muted">
                    Chưa có tin nhắn
                  </li>
                </ul>
              </div>
            </ng-scrollbar>

            <!-- Ô input + CHỈ giữ nút gửi (Send) -->
            <div class="chat-message clearfix" style="display: flex; align-items: center; gap: 8px;">
              <!-- Ô nhập (chiếm hết chỗ còn lại) -->
              <div style="flex: 1;">
                <mat-form-field class="example-full-width" appearance="outline">
                  <input matInput placeholder="Enter text here..." [(ngModel)]="newMessageContent"
                    (keyup.enter)="sendMessage()" required />
                </mat-form-field>
              </div>

              <!-- Nút Send duy nhất -->
              <button mat-mini-fab color="primary" (click)="sendMessage()"
                [disabled]="!newMessageContent.trim() || !selectedContactId">
                <i class="material-icons">send</i>
              </button>
            </div>
            <!-- Hết phần chỉnh sửa Ô input + Nút gửi -->
          </div>
        </div>
      </div>
    </div> <!-- end row -->
  </div>
</section>